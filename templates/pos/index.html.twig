{% extends 'base.html.twig' %}

{% block title %}Point of Sale â€” Floryn Garden{% endblock %}
{% block page_title %}Point of Sale{% endblock %}

{% block body %}
<div {{ stimulus_controller('pos') }}
     data-pos-flowers-url-value="{{ path('app_pos_search_flowers') }}"
     data-pos-customers-url-value="{{ path('app_pos_search_customers') }}"
     data-pos-checkout-url-value="{{ path('app_pos_checkout') }}"
     data-pos-csrf-value="{{ csrf_token('pos_checkout') }}"
     data-pos-flowers-value="{{ flowers|map(f => {
       id: f.id,
       name: f.name,
       category: f.category,
       price: f.price,
       discountPrice: f.discountPrice,
       effectivePrice: f.discountPrice > 0 ? f.discountPrice : f.price,
       stock: f.stockQuantity,
       freshness: f.freshnessStatus
     })|json_encode }}"
     data-pos-customers-value="{{ customers|map(c => {
       id: c.id,
       fullName: c.fullName,
       phone: c.phone,
       email: c.email,
       address: c.address
     })|json_encode }}">

  {# Page Header #}
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 style="font-family:'Bricolage Grotesque',serif;font-size:24px;font-weight:700;color:#293855;">
        <i class="fas fa-cash-register mr-2 text-[#4265d6]"></i>Point of Sale
      </h1>
      <p style="font-size:13px;color:#6b7a8d;margin-top:2px;">Walk-in sales â€” single-screen checkout</p>
    </div>
    <div class="flex items-center gap-3">
      <span data-controller="clock" style="font-size:13px;color:#6b7a8d;font-variant-numeric:tabular-nums;"></span>
      <button type="button" data-action="pos#resetAll"
              class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200"
              style="background:#fee2e2;color:#991b1b;">
        <i class="fas fa-redo mr-1"></i> New Sale
      </button>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">

    {# â”€â”€ LEFT: Flower Catalog (2/3 width) â”€â”€ #}
    <div class="lg:col-span-2 space-y-4">

      {# Search & Filter Bar #}
      <div class="bg-white rounded-xl p-4" style="border:1px solid #e8edf2;">
        <div class="flex items-center gap-3">
          <div class="flex-1 relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
            <input type="text" data-pos-target="flowerSearch" data-action="input->pos#filterFlowers"
                   class="w-full pl-9 pr-4 py-2.5 rounded-lg text-sm"
                   style="border:1px solid #e8edf2;outline:none;"
                   placeholder="Search flowers by name or category...">
          </div>
          <select data-pos-target="categoryFilter" data-action="change->pos#filterFlowers"
                  class="py-2.5 px-3 rounded-lg text-sm" style="border:1px solid #e8edf2;outline:none;min-width:160px;">
            <option value="">All Categories</option>
            {% set seen = {} %}
            {% for f in flowers %}
              {% if f.category is not null and f.category not in seen|keys %}
                {% set seen = seen|merge({ (f.category): true }) %}
              {% endif %}
            {% endfor %}
            {% for cat in seen|keys|sort %}
              <option value="{{ cat }}">{{ cat }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      {# Flower Grid #}
      <div data-pos-target="flowerGrid"
           class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3"
           style="max-height:calc(100vh - 260px);overflow-y:auto;padding-bottom:8px;">
        {% for flower in flowers %}
          <div class="pos-flower-card bg-white rounded-xl overflow-hidden cursor-pointer transition-all duration-200 hover:shadow-md group"
               style="border:1px solid #e8edf2;"
               data-action="click->pos#addToCart"
               data-flower-id="{{ flower.id }}"
               data-flower-name="{{ flower.name }}"
               data-flower-category="{{ flower.category }}"
               data-flower-price="{{ flower.price }}"
               data-flower-discount="{{ flower.discountPrice ?? 0 }}"
               data-flower-effective="{{ flower.discountPrice > 0 ? flower.discountPrice : flower.price }}"
               data-flower-stock="{{ flower.stockQuantity }}"
               data-flower-freshness="{{ flower.freshnessStatus }}">
            <div class="p-4">
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center justify-center w-10 h-10 rounded-lg" style="background:#fdf2f8;">
                  <span style="font-size:20px;">ðŸŒ¸</span>
                </div>
                <span class="inline-flex px-2 py-0.5 rounded-full text-[10px] font-medium
                  {% if flower.freshnessStatus == 'Fresh' %}bg-green-100 text-green-800
                  {% elseif flower.freshnessStatus == 'Good' %}bg-yellow-100 text-yellow-800
                  {% elseif flower.freshnessStatus == 'Last Sale' %}bg-orange-100 text-orange-800
                  {% else %}bg-red-100 text-red-800{% endif %}">
                  {{ flower.freshnessStatus }}
                </span>
              </div>
              <h3 class="text-sm font-semibold text-gray-900 truncate" title="{{ flower.name }}">{{ flower.name }}</h3>
              <p class="text-[11px] text-gray-500 mb-2">{{ flower.category }}</p>
              <div class="flex items-center justify-between">
                <div>
                  {% if flower.discountPrice > 0 %}
                    <span class="text-xs line-through text-gray-400">â‚±{{ flower.price|number_format(2) }}</span>
                    <span class="text-sm font-bold text-green-600">â‚±{{ flower.discountPrice|number_format(2) }}</span>
                  {% else %}
                    <span class="text-sm font-bold text-gray-900">â‚±{{ flower.price|number_format(2) }}</span>
                  {% endif %}
                </div>
                <span class="text-[11px] font-medium {% if flower.stockQuantity < 5 %}text-red-600{% else %}text-gray-500{% endif %}">
                  {{ flower.stockQuantity }} left
                </span>
              </div>
            </div>
            <div class="bg-[#4265d6] text-white text-center py-1.5 text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity duration-200">
              <i class="fas fa-plus mr-1"></i> Add to Cart
            </div>
          </div>
        {% endfor %}
      </div>

      {# Empty State #}
      <div data-pos-target="emptyFlowers" class="hidden text-center py-12 bg-white rounded-xl" style="border:1px solid #e8edf2;">
        <i class="fas fa-search text-gray-300 text-4xl mb-3"></i>
        <p class="text-gray-500 text-sm">No flowers match your search.</p>
      </div>
    </div>

    {# â”€â”€ RIGHT: Cart & Checkout (1/3 width) â”€â”€ #}
    <div class="space-y-4">

      {# Customer Section #}
      <div class="bg-white rounded-xl overflow-hidden" style="border:1px solid #e8edf2;">
        <div class="px-4 py-3 flex items-center justify-between" style="background:#f8fafc;border-bottom:1px solid #e8edf2;">
          <h3 class="text-sm font-semibold text-gray-800"><i class="fas fa-user mr-1.5 text-[#4265d6]"></i>Customer</h3>
          <button type="button" data-action="pos#toggleCustomerMode" data-pos-target="customerToggle"
                  class="text-[11px] font-medium px-2.5 py-1 rounded-md transition-colors"
                  style="background:#dbeafe;color:#1e40af;">
            Walk-in
          </button>
        </div>
        <div class="p-4 space-y-3">
          {# Existing Customer Search #}
          <div data-pos-target="existingCustomerSection" class="hidden">
            <div class="relative">
              <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
              <input type="text" data-pos-target="customerSearch" data-action="input->pos#searchCustomers"
                     class="w-full pl-9 pr-4 py-2 rounded-lg text-sm"
                     style="border:1px solid #e8edf2;outline:none;"
                     placeholder="Search customer by name/phone...">
            </div>
            <div data-pos-target="customerResults" class="mt-2 max-h-40 overflow-y-auto hidden">
              {# Dynamic customer results #}
            </div>
            <div data-pos-target="selectedCustomer" class="mt-2 hidden">
              <div class="flex items-center justify-between p-3 rounded-lg" style="background:#dcfce7;border:1px solid #bbf7d0;">
                <div>
                  <div class="text-sm font-medium text-green-800" data-pos-target="selectedCustomerName"></div>
                  <div class="text-[11px] text-green-600" data-pos-target="selectedCustomerInfo"></div>
                </div>
                <button type="button" data-action="pos#clearCustomer" class="text-green-600 hover:text-green-800">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>

          {# Walk-in Customer Fields #}
          <div data-pos-target="walkinSection" class="space-y-2">
            <input type="text" data-pos-target="walkinName"
                   class="w-full px-3 py-2 rounded-lg text-sm" style="border:1px solid #e8edf2;outline:none;"
                   placeholder="Customer name (optional)">
            <input type="text" data-pos-target="walkinPhone"
                   class="w-full px-3 py-2 rounded-lg text-sm" style="border:1px solid #e8edf2;outline:none;"
                   placeholder="Phone e.g. +639123456789 (optional)">
            <input type="email" data-pos-target="walkinEmail"
                   class="w-full px-3 py-2 rounded-lg text-sm" style="border:1px solid #e8edf2;outline:none;"
                   placeholder="Email (optional)">
          </div>
        </div>
      </div>

      {# Cart Section #}
      <div class="bg-white rounded-xl overflow-hidden" style="border:1px solid #e8edf2;">
        <div class="px-4 py-3 flex items-center justify-between" style="background:#f8fafc;border-bottom:1px solid #e8edf2;">
          <h3 class="text-sm font-semibold text-gray-800"><i class="fas fa-shopping-cart mr-1.5 text-[#4265d6]"></i>Cart</h3>
          <span data-pos-target="cartCount" class="text-[11px] font-medium px-2 py-0.5 rounded-full" style="background:#eef2ff;color:#4265d6;">0 items</span>
        </div>

        {# Cart Items #}
        <div data-pos-target="cartItems" class="divide-y divide-gray-100" style="max-height:300px;overflow-y:auto;">
          {# Dynamic cart items via Stimulus #}
        </div>

        {# Empty Cart State #}
        <div data-pos-target="emptyCart" class="py-8 text-center">
          <i class="fas fa-shopping-basket text-gray-300 text-3xl mb-2"></i>
          <p class="text-sm text-gray-400">Click a flower to add it</p>
        </div>

        {# Cart Totals #}
        <div data-pos-target="cartTotals" class="hidden px-4 py-3 space-y-2" style="background:#f8fafc;border-top:1px solid #e8edf2;">
          <div class="flex justify-between text-sm text-gray-600">
            <span>Subtotal</span>
            <span data-pos-target="subtotalDisplay">â‚±0.00</span>
          </div>
          <div class="flex justify-between text-base font-bold text-gray-900 pt-1" style="border-top:1px solid #e8edf2;">
            <span>Total</span>
            <span data-pos-target="totalDisplay" class="text-[#4265d6]">â‚±0.00</span>
          </div>
        </div>
      </div>

      {# Payment Section #}
      <div class="bg-white rounded-xl overflow-hidden" style="border:1px solid #e8edf2;">
        <div class="px-4 py-3" style="background:#f8fafc;border-bottom:1px solid #e8edf2;">
          <h3 class="text-sm font-semibold text-gray-800"><i class="fas fa-money-bill-wave mr-1.5 text-[#4265d6]"></i>Payment</h3>
        </div>
        <div class="p-4 space-y-3">
          <div class="grid grid-cols-3 gap-2">
            {% set methods = ['Cash', 'GCash', 'Credit Card', 'Debit Card', 'PayMaya', 'Bank Transfer'] %}
            {% for method in methods %}
              <button type="button" data-action="pos#selectPayment"
                      data-payment-method="{{ method }}"
                      data-pos-target="paymentBtn"
                      class="pos-payment-btn py-2 px-2 rounded-lg text-[11px] font-medium text-center transition-all duration-200"
                      style="border:1px solid #e8edf2;color:#6b7a8d;">
                {% if method == 'Cash' %}<i class="fas fa-money-bill-alt block text-base mb-0.5"></i>
                {% elseif method == 'GCash' %}<i class="fas fa-mobile-alt block text-base mb-0.5"></i>
                {% elseif method == 'Credit Card' %}<i class="fas fa-credit-card block text-base mb-0.5"></i>
                {% elseif method == 'Debit Card' %}<i class="fas fa-credit-card block text-base mb-0.5"></i>
                {% elseif method == 'PayMaya' %}<i class="fas fa-wallet block text-base mb-0.5"></i>
                {% elseif method == 'Bank Transfer' %}<i class="fas fa-university block text-base mb-0.5"></i>
                {% endif %}
                {{ method }}
              </button>
            {% endfor %}
          </div>
        </div>
      </div>

      {# Checkout Button #}
      <button type="button" data-action="pos#checkout" data-pos-target="checkoutBtn"
              class="w-full py-3.5 rounded-xl text-white text-sm font-semibold transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
              style="background:#4265d6;" disabled>
        <i class="fas fa-check-circle mr-2"></i>Complete Sale
      </button>

      {# Processing State #}
      <div data-pos-target="processingOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background:rgba(0,0,0,0.5);">
        <div class="bg-white rounded-2xl p-8 text-center shadow-2xl" style="min-width:300px;">
          <div class="animate-spin w-12 h-12 border-4 border-[#4265d6] border-t-transparent rounded-full mx-auto mb-4"></div>
          <p class="text-lg font-semibold text-gray-800">Processing Sale...</p>
          <p class="text-sm text-gray-500 mt-1">Please wait while we complete your transaction.</p>
        </div>
      </div>

      {# Success Modal #}
      <div data-pos-target="successModal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background:rgba(0,0,0,0.5);">
        <div class="bg-white rounded-2xl p-8 text-center shadow-2xl" style="min-width:380px;max-width:440px;">
          <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-check text-green-600 text-2xl"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-1">Sale Complete!</h3>
          <p class="text-sm text-gray-500 mb-4">Transaction processed successfully.</p>
          <div class="bg-gray-50 rounded-lg p-4 mb-5 text-left space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Reference</span>
              <span class="font-mono font-medium text-gray-900" data-pos-target="receiptRef"></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Customer</span>
              <span class="font-medium text-gray-900" data-pos-target="receiptCustomer"></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Total Paid</span>
              <span class="font-bold text-[#4265d6]" data-pos-target="receiptTotal"></span>
            </div>
          </div>
          <div class="flex gap-3">
            <a data-pos-target="receiptViewLink" href="#" class="flex-1 py-2.5 rounded-lg text-sm font-medium transition-colors" style="background:#eef2ff;color:#4265d6;">
              <i class="fas fa-eye mr-1"></i> View
            </a>
            <button type="button" data-action="pos#resetAll" class="flex-1 py-2.5 rounded-lg text-white text-sm font-medium" style="background:#4265d6;">
              <i class="fas fa-plus mr-1"></i> New Sale
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{# Clock is handled by the Stimulus clock controller attached above #}
