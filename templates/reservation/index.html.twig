{% extends 'base.html.twig' %}

{% block title %}Reservations - Floryn Garden{% endblock %}
{% block page_title %}Reservation Management{% endblock %}

{% block body %}
<div class="page-wrapper px-4 sm:px-6 lg:px-8">
  <div class="page-header">
    <div class="page-header-info">
      <h1><i class="fas fa-calendar-alt" style="color:#4265d6;font-size:22px;"></i> Order Reservations</h1>
      <p class="subtitle">Manage customer flower reservations, track pickup dates, and monitor payment status.</p>
    </div>
    <div class="page-header-actions">
      <a href="{{ path('app_reservation_new') }}" class="btn btn-primary"><i class="fas fa-calendar-plus"></i> New Reservation</a>
    </div>
  </div>

  <div class="stat-grid">
    <div class="stat-card">
      <div class="stat-icon purple"><i class="fas fa-calendar-alt"></i></div>
      <div class="stat-content">
        <div class="stat-label">Total Reservations</div>
        <div class="stat-value">{{ reservations|length }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon amber"><i class="fas fa-clock"></i></div>
      <div class="stat-content">
        <div class="stat-label">Pending</div>
        <div class="stat-value">{% set pending = 0 %}{% for reservation in reservations %}{% if reservation.reservationStatus == 'Pending' %}{% set pending = pending + 1 %}{% endif %}{% endfor %}{{ pending }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
      <div class="stat-content">
        <div class="stat-label">Completed</div>
        <div class="stat-value">{% set completed = 0 %}{% for reservation in reservations %}{% if reservation.reservationStatus == 'Completed' %}{% set completed = completed + 1 %}{% endif %}{% endfor %}{{ completed }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon blue"><i class="fas fa-dollar-sign"></i></div>
      <div class="stat-content">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value">₱{% set totalRevenue = 0 %}{% for reservation in reservations %}{% set totalRevenue = totalRevenue + reservation.totalAmount %}{% endfor %}{{ totalRevenue|number_format(2) }}</div>
      </div>
    </div>
  </div>

  {% if reservations is not empty %}
  <div class="table-card"
       data-controller="floryn-table"
       data-floryn-table-page-size-value="10"
       data-floryn-table-sort-col-value="2"
       data-floryn-table-sort-dir-value="desc"
       data-floryn-table-no-sort-cols-value="[6]"
       data-floryn-table-entity-name-value="reservations">

    <div class="table-card-header"><h3>All Reservations</h3></div>

    <div class="fg-toolbar">
      <div class="fg-toolbar-left">
        <select class="fg-page-size" data-floryn-table-target="pageSize" data-action="floryn-table#onPageSizeChange">
          <option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="-1">All</option>
        </select>
        <div class="fg-export-buttons">
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportCopy"><i class="fas fa-copy"></i> Copy</button>
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportCsv"><i class="fas fa-file-csv"></i> CSV</button>
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportExcel"><i class="fas fa-file-excel"></i> Excel</button>
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportPrint"><i class="fas fa-print"></i> Print</button>
        </div>
      </div>
      <div class="fg-toolbar-right">
        <select class="filter-select" data-floryn-table-target="columnFilter" data-col="5" data-action="floryn-table#onColumnFilter">
          <option value="">All Status</option><option value="Pending">Pending</option><option value="Confirmed">Confirmed</option><option value="Completed">Completed</option><option value="Cancelled">Cancelled</option>
        </select>
        <select class="filter-select" data-floryn-table-target="columnFilter" data-col="4" data-action="floryn-table#onColumnFilter">
          <option value="">All Payments</option><option value="Paid">Paid</option><option value="Unpaid">Unpaid</option>
        </select>
        <button type="button" class="btn-outline" data-action="floryn-table#resetFilters" style="padding:8px 14px;font-size:12px;"><i class="fas fa-redo"></i> Reset</button>
        <div class="fg-search-wrap">
          <i class="fas fa-search fg-search-icon"></i>
          <input type="text" class="fg-search" placeholder="Search reservations..." data-floryn-table-target="search" data-action="input->floryn-table#onSearch">
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="fg-table min-w-full" style="width:100%" data-floryn-table-target="table">
        <thead>
          <tr><th>Reservation</th><th>Customer</th><th>Pickup Date</th><th>Amount</th><th>Payment</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody>
          {% for reservation in reservations %}
            <tr>
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <div class="avatar sm" style="background:linear-gradient(135deg,#9b59b6,#8e44ad);"><i class="fas fa-receipt" style="font-size:11px;"></i></div>
                  <div>
                    <div style="font-weight:600;color:var(--navy);font-size:13px;">#{{ reservation.id }}</div>
                    <div style="font-size:11px;color:var(--muted);">{{ reservation.dateReserved ? reservation.dateReserved|date('M j, Y') : 'No date' }}</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <div class="avatar sm" style="background:linear-gradient(135deg,#7c5cbf,#9b59b6);font-size:10px;">{{ reservation.customer.fullName|first|upper }}</div>
                  <div>
                    <div style="font-weight:600;font-size:13px;color:var(--navy);">{{ reservation.customer.fullName }}</div>
                    <div style="font-size:11px;color:var(--muted);">{{ reservation.customer.email }}</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3" style="font-size:13px;">
                {% if reservation.pickupDate %}
                  {% set today = date() %}
                  {% set pickupDays = date(reservation.pickupDate).diff(today).days %}
                  <div>{{ reservation.pickupDate|date('M j, Y') }}</div>
                  <div style="font-size:11px;" class="{% if pickupDays < 0 %}text-red-500{% elseif pickupDays == 0 %}text-amber-500{% elseif pickupDays <= 3 %}text-blue-500{% else %}text-gray-500{% endif %}">
                    {% if pickupDays < 0 %}{{ pickupDays|abs }} days overdue{% elseif pickupDays == 0 %}Today{% else %}In {{ pickupDays }} days{% endif %}
                  </div>
                {% else %}<span style="color:var(--muted);">Not set</span>{% endif %}
              </td>
              <td class="px-4 py-3"><div style="font-weight:700;font-size:16px;color:var(--navy);">₱{{ reservation.totalAmount|number_format(2) }}</div></td>
              <td class="px-4 py-3">
                <span class="pill {% if reservation.paymentStatus == 'Paid' %}green{% else %}red{% endif %}">
                  {% if reservation.paymentStatus == 'Paid' %}<i class="fas fa-check-circle" style="margin-right:3px;"></i>{% else %}<i class="fas fa-times-circle" style="margin-right:3px;"></i>{% endif %}
                  {{ reservation.paymentStatus }}
                </span>
              </td>
              <td class="px-4 py-3">
                <span class="pill {% if reservation.reservationStatus == 'Completed' %}green{% elseif reservation.reservationStatus == 'Confirmed' %}blue{% elseif reservation.reservationStatus == 'Pending' %}yellow{% else %}red{% endif %}">{{ reservation.reservationStatus }}</span>
              </td>
              <td class="px-4 py-3 text-right">
                <div class="row-actions">
                  <a href="{{ path('app_reservation_show', {'id': reservation.id}) }}" class="row-action-btn" title="View"><i class="fas fa-eye"></i></a>
                  <a href="{{ path('app_reservation_edit', {'id': reservation.id}) }}" class="row-action-btn" title="Edit"><i class="fas fa-edit"></i></a>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="fg-bottom-bar">
      <div class="fg-info" data-floryn-table-target="info"></div>
      <div class="fg-pagination" data-floryn-table-target="pagination"></div>
    </div>

  {% else %}
    <div class="section-card">
      <div class="empty-state">
        <div class="empty-state-icon"><i class="fas fa-calendar-alt"></i></div>
        <h3>No reservations found</h3>
        <p>Start taking orders by creating your first reservation.</p>
        <a href="{{ path('app_reservation_new') }}" class="btn btn-primary"><i class="fas fa-calendar-plus"></i> Create First Reservation</a>
      </div>
    </div>
  {% endif %}
  </div>
</div>
{% endblock %}