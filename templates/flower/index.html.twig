{% extends 'base.html.twig' %}

{% block title %}Flowers{% endblock %}
{% block page_title %}Flowers Management{% endblock %}

{% block body %}
<div class="page-wrapper px-4 sm:px-6 lg:px-8">
  <div class="page-header">
    <div class="page-header-info">
      <h1><i class="fas fa-leaf" style="color:#4265d6;font-size:22px;"></i> Flower Inventory</h1>
      <p class="subtitle">Manage your flower inventory, track stock levels, and monitor freshness status.</p>
    </div>
    <div class="page-header-actions">
      <a href="{{ path('app_flower_new') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Add New Flower</a>
    </div>
  </div>

  <div class="stat-grid" style="grid-template-columns:repeat(4,1fr);">
    <div class="stat-card">
      <div class="stat-icon blue"><i class="fas fa-leaf"></i></div>
      <div class="stat-content">
        <div class="stat-label">Active Flowers</div>
        <div class="stat-value">{{ flowers|length }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon amber"><i class="fas fa-exclamation-triangle"></i></div>
      <div class="stat-content">
        <div class="stat-label">Low Stock</div>
        <div class="stat-value">{% set lowStock = 0 %}{% for flower in flowers %}{% if flower.stockQuantity < 5 and flower.stockQuantity > 0 %}{% set lowStock = lowStock + 1 %}{% endif %}{% endfor %}{{ lowStock }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon red"><i class="fas fa-times-circle"></i></div>
      <div class="stat-content">
        <div class="stat-label">Sold Out</div>
        <div class="stat-value">{{ soldFlowers|length }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon purple"><i class="fas fa-dollar-sign"></i></div>
      <div class="stat-content">
        <div class="stat-label">Total Value</div>
        <div class="stat-value">₱{% set totalValue = 0 %}{% for flower in flowers %}{% set totalValue = totalValue + (flower.price * flower.stockQuantity) %}{% endfor %}{{ totalValue|number_format(2) }}</div>
      </div>
    </div>
  </div>

  {% if flowers is not empty %}
  <div class="table-card"
       data-controller="floryn-table"
       data-floryn-table-page-size-value="10"
       data-floryn-table-sort-col-value="0"
       data-floryn-table-sort-dir-value="asc"
       data-floryn-table-no-sort-cols-value="[8]"
       data-floryn-table-entity-name-value="flowers">

    <div class="table-card-header">
      <h3><i class="fas fa-check-circle" style="color:#22c55e;margin-right:6px;"></i> Active Inventory</h3>
    </div>

    <div class="fg-toolbar">
      <div class="fg-toolbar-left">
        <select class="fg-page-size" data-floryn-table-target="pageSize" data-action="floryn-table#onPageSizeChange">
          <option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="-1">All</option>
        </select>
        <div class="fg-export-buttons">
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportCopy"><i class="fas fa-copy"></i> Copy</button>
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportCsv"><i class="fas fa-file-csv"></i> CSV</button>
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportExcel"><i class="fas fa-file-excel"></i> Excel</button>
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportPrint"><i class="fas fa-print"></i> Print</button>
        </div>
      </div>
      <div class="fg-toolbar-right">
        <select class="filter-select" data-floryn-table-target="columnFilter" data-col="7" data-action="floryn-table#onColumnFilter">
          <option value="">All Status</option><option value="Available">Available</option><option value="Reserved">Reserved</option>
        </select>
        <select class="filter-select" data-floryn-table-target="columnFilter" data-col="5" data-action="floryn-table#onColumnFilter">
          <option value="">All Freshness</option><option value="Fresh">Fresh</option><option value="Good">Good</option><option value="Last Sale">Last Sale</option>
        </select>
        <button type="button" class="btn-outline" data-action="floryn-table#resetFilters" style="padding:8px 14px;font-size:12px;"><i class="fas fa-redo"></i> Reset</button>
        <div class="fg-search-wrap">
          <i class="fas fa-search fg-search-icon"></i>
          <input type="text" class="fg-search" placeholder="Search flowers..." data-floryn-table-target="search" data-action="input->floryn-table#onSearch">
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="fg-table min-w-full" style="width:100%" data-floryn-table-target="table">
        <thead>
          <tr>
            <th>Flower</th><th>Category</th><th>Price</th><th>Stock</th><th>Batches</th><th>Freshness</th><th>Expiry Date</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for flower in flowers %}
            <tr>
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <div class="avatar sm" style="background:linear-gradient(135deg,#e88da0,#d65d7a);"><i class="fas fa-leaf" style="font-size:13px;"></i></div>
                  <div>
                    <div style="font-weight:600;color:var(--navy);font-size:13px;">{{ flower.name }}</div>
                    <div style="font-size:11px;color:var(--muted);">ID: {{ flower.id }}</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3"><span class="pill navy">{{ flower.category }}</span></td>
              <td class="px-4 py-3" data-order="{{ flower.discountPrice ?: flower.price }}">
                {% if flower.discountPrice %}
                  <div style="font-weight:600;color:#c0392b;">₱{{ flower.discountPrice|number_format(2) }}</div>
                  <div style="font-size:11px;text-decoration:line-through;color:var(--muted);">₱{{ flower.price|number_format(2) }}</div>
                {% else %}
                  <div style="font-weight:600;color:var(--navy);">₱{{ flower.price|number_format(2) }}</div>
                {% endif %}
              </td>
              <td class="px-4 py-3" data-order="{{ flower.stockQuantity }}">
                <div class="stock-cell">
                  <div class="stock-num {% if flower.stockQuantity < 5 %}low{% elseif flower.stockQuantity > 20 %}high{% else %}ok{% endif %}">{{ flower.stockQuantity }}</div>
                  <div class="stock-bar-wrap"><div class="stock-bar {% if flower.stockQuantity < 5 %}low{% elseif flower.stockQuantity > 20 %}high{% else %}ok{% endif %}" style="width:{{ (flower.stockQuantity > 50 ? 50 : flower.stockQuantity) / 50 * 100 }}%;"></div></div>
                </div>
              </td>
              <td class="px-4 py-3" style="text-align:center;">
                {% set activeBatchCount = flower.activeBatches|length %}
                {% if activeBatchCount > 0 %}
                  <span class="pill blue" style="font-size:11px;">{{ activeBatchCount }} batch{{ activeBatchCount > 1 ? 'es' : '' }}</span>
                {% else %}
                  <span style="color:var(--muted);font-size:11px;">—</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                <span class="pill {% if flower.freshnessStatus == 'Fresh' %}green{% elseif flower.freshnessStatus == 'Good' %}yellow{% elseif flower.freshnessStatus == 'Last Sale' %}orange{% else %}red{% endif %}">
                  {{ flower.freshnessStatus }}
                </span>
              </td>
              <td class="px-4 py-3" data-order="{{ flower.expiryDate ? flower.expiryDate|date('Y-m-d') : '9999-12-31' }}">
                {% if flower.expiryDate %}
                  {% set today = date() %}
                  {% set expiryDays = date(flower.expiryDate).diff(today).days %}
                  <div class="{% if expiryDays < 3 %}text-red-600{% elseif expiryDays < 7 %}text-yellow-600{% endif %}" style="font-size:13px;">
                    {{ flower.expiryDate|date('M d, Y') }}
                    {% if expiryDays < 7 %}<div style="font-size:11px;" class="{% if expiryDays < 3 %}text-red-500{% else %}text-yellow-500{% endif %}">({{ expiryDays }}d left)</div>{% endif %}
                  </div>
                {% else %}<span style="color:var(--muted);font-size:12px;">Not set</span>{% endif %}
              </td>
              <td class="px-4 py-3">
                <span class="pill {% if flower.status == 'Available' %}green{% elseif flower.status == 'Reserved' %}blue{% else %}red{% endif %}">{{ flower.status }}</span>
              </td>
              <td class="px-4 py-3 text-right">
                <div class="row-actions">
                  <a href="{{ path('app_flower_show', {'id': flower.id}) }}" class="row-action-btn" title="View"><i class="fas fa-eye"></i></a>
                  <a href="{{ path('app_flower_edit', {'id': flower.id}) }}" class="row-action-btn" title="Edit"><i class="fas fa-edit"></i></a>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="fg-bottom-bar">
      <div class="fg-info" data-floryn-table-target="info"></div>
      <div class="fg-pagination" data-floryn-table-target="pagination"></div>
    </div>

  {% else %}
    <div class="section-card">
      <div class="empty-state">
        <div class="empty-state-icon"><i class="fas fa-leaf"></i></div>
        <h3>No active flowers</h3>
        <p>All flowers have been sold or none have been added yet.</p>
        <a href="{{ path('app_flower_new') }}" class="btn btn-primary"><i class="fas fa-plus"></i> Add New Flower</a>
      </div>
    </div>
  {% endif %}

  {# ── Sold Out / Unavailable Section ── #}
  {% if soldFlowers is not empty %}
  <div class="table-card" style="margin-top:24px;opacity:0.85;">
    <div class="table-card-header" style="background:#f9fafb;border-bottom:1px solid #e8edf2;">
      <h3 style="color:#6b7280;"><i class="fas fa-archive" style="margin-right:6px;color:#9ca3af;"></i> Sold Out / Unavailable <span style="font-size:12px;font-weight:400;color:#9ca3af;margin-left:8px;">({{ soldFlowers|length }} flower{{ soldFlowers|length > 1 ? 's' : '' }})</span></h3>
    </div>

    <div class="overflow-x-auto">
      <table class="fg-table min-w-full" style="width:100%;">
        <thead>
          <tr>
            <th>Flower</th><th>Category</th><th>Original Price</th><th>Sold Out On</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for flower in soldFlowers %}
            <tr style="background:#fafafa;">
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <div class="avatar sm" style="background:linear-gradient(135deg,#d1d5db,#9ca3af);"><i class="fas fa-leaf" style="font-size:13px;"></i></div>
                  <div>
                    <div style="font-weight:600;color:#6b7280;font-size:13px;">{{ flower.name }}</div>
                    <div style="font-size:11px;color:var(--muted);">ID: {{ flower.id }}</div>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3"><span class="pill" style="background:#f3f4f6;color:#6b7280;">{{ flower.category }}</span></td>
              <td class="px-4 py-3">
                <div style="font-weight:600;color:#6b7280;">₱{{ flower.price|number_format(2) }}</div>
              </td>
              <td class="px-4 py-3" style="color:#6b7280;font-size:13px;">
                {% if flower.soldAt %}
                  {{ flower.soldAt|date('M d, Y') }}
                  <div style="font-size:11px;color:#9ca3af;">{{ date().diff(flower.soldAt).days }} days ago</div>
                {% else %}
                  <span style="color:#9ca3af;font-size:12px;">—</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                <span class="pill red">{{ flower.stockQuantity <= 0 ? 'Sold Out' : flower.status }}</span>
              </td>
              <td class="px-4 py-3 text-right">
                <div class="row-actions" style="gap:4px;">
                  <a href="{{ path('app_flower_show', {'id': flower.id}) }}" class="row-action-btn" title="View"><i class="fas fa-eye"></i></a>
                  <button type="button" class="row-action-btn" title="Restock" style="color:#16a34a;cursor:pointer;border:none;background:none;" onclick="document.getElementById('restock-form-{{ flower.id }}').style.display = document.getElementById('restock-form-{{ flower.id }}').style.display === 'none' ? 'table-row' : 'none'"><i class="fas fa-plus-circle"></i></button>
                </div>
              </td>
            </tr>
            {# Inline restock form row #}
            <tr id="restock-form-{{ flower.id }}" style="display:none;background:#f0fdf4;">
              <td colspan="6" class="px-4 py-4">
                <form action="{{ path('app_flower_restock', {'id': flower.id}) }}" method="post" class="flex items-end gap-4 flex-wrap">
                  <input type="hidden" name="_token" value="{{ csrf_token('restock' ~ flower.id) }}">
                  <div>
                    <label style="font-size:12px;font-weight:500;color:#374151;display:block;margin-bottom:4px;">New Stock Quantity</label>
                    <input type="number" name="stock_quantity" min="1" required placeholder="e.g. 20" style="width:140px;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:13px;">
                  </div>
                  <div>
                    <label style="font-size:12px;font-weight:500;color:#374151;display:block;margin-bottom:4px;">New Expiry Date</label>
                    <input type="date" name="expiry_date" required min="{{ 'now'|date('Y-m-d') }}" style="width:170px;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:13px;">
                  </div>
                  <button type="submit" class="btn btn-primary" style="padding:8px 20px;font-size:13px;"><i class="fas fa-redo" style="margin-right:4px;"></i> Restock</button>
                  <button type="button" onclick="document.getElementById('restock-form-{{ flower.id }}').style.display='none'" class="btn btn-outline" style="padding:8px 14px;font-size:13px;">Cancel</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  </div>
</div>
{% endblock %}