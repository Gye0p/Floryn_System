{% extends 'base.html.twig' %}

{% block title %}Dashboard | Floryn Garden{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block body %}
<div style="animation:fadeUp 0.4s ease both;">

  {% if lowStockFlowers is not empty %}
  <div class="flex items-center gap-3 rounded-xl mb-5" style="background:linear-gradient(135deg,#293855,#3a4f6e);padding:14px 20px;">
    <div style="font-size:20px;">&#x26A0;&#xFE0F;</div>
    <div class="flex-1">
      <div style="font-size:13px;font-weight:600;color:#c2e7c9;">Low Stock Alert</div>
      <div style="font-size:12px;color:rgba(194,231,201,0.6);margin-top:2px;">
        {{ lowStockFlowers|length }} flower{{ lowStockFlowers|length > 1 ? ' varieties are' : ' variety is' }} running low on stock.
      </div>
    </div>
    <a href="{{ path('app_flower_index') }}" style="background:#c2e7c9;color:#293855;border:none;border-radius:6px;padding:7px 14px;font-size:12px;font-weight:600;text-decoration:none;">
      Restock Now
    </a>
  </div>
  {% endif %}

  <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-7">
    <div class="rounded-xl p-5 relative overflow-hidden" style="background:#293855;border:1px solid #293855;">
      <div class="flex items-center justify-center rounded-lg mb-3.5" style="width:36px;height:36px;background:rgba(194,231,201,0.12);font-size:17px;">&#x1F4B0;</div>
      <div style="font-size:12px;color:rgba(194,231,201,0.55);margin-bottom:6px;">Last Sale Savings</div>
      <div style="font-family:'Bricolage Grotesque',serif;font-size:28px;font-weight:700;color:#c2e7c9;line-height:1;margin-bottom:8px;">₱{{ savingsData.totalSavings|number_format(2) }}</div>
      <div style="font-size:12px;color:rgba(194,231,201,0.7);font-weight:500;">{{ savingsData.discountedItemsCount }} items discounted</div>
    </div>
    <div class="rounded-xl p-5 bg-white relative overflow-hidden" style="border:1px solid #e8edf2;">
      <div class="flex items-center justify-center rounded-lg mb-3.5" style="width:36px;height:36px;background:#e8f7eb;font-size:17px;">&#x1F33A;</div>
      <div style="font-size:12px;color:#6b7a8d;margin-bottom:6px;">Active Flowers</div>
      <div style="font-family:'Bricolage Grotesque',serif;font-size:28px;font-weight:700;color:#293855;line-height:1;margin-bottom:8px;">{{ totalFlowers }}</div>
      <a href="{{ path('app_flower_index') }}" style="font-size:12px;color:#4265d6;font-weight:500;text-decoration:none;">View inventory &#x2192;</a>
    </div>
    <div class="rounded-xl p-5 bg-white relative overflow-hidden" style="border:1px solid #e8edf2;">
      <div class="flex items-center justify-center rounded-lg mb-3.5" style="width:36px;height:36px;background:#e8f7eb;font-size:17px;">&#x1F69A;</div>
      <div style="font-size:12px;color:#6b7a8d;margin-bottom:6px;">Total Suppliers</div>
      <div style="font-family:'Bricolage Grotesque',serif;font-size:28px;font-weight:700;color:#293855;line-height:1;margin-bottom:8px;">{{ totalSuppliers }}</div>
      <a href="{{ path('app_supplier_index') }}" style="font-size:12px;color:#4265d6;font-weight:500;text-decoration:none;">View suppliers &#x2192;</a>
    </div>
    <div class="rounded-xl p-5 bg-white relative overflow-hidden" style="border:1px solid #e8edf2;">
      <div class="flex items-center justify-center rounded-lg mb-3.5" style="width:36px;height:36px;background:#e8f7eb;font-size:17px;">&#x1F465;</div>
      <div style="font-size:12px;color:#6b7a8d;margin-bottom:6px;">Active Customers</div>
      <div style="font-family:'Bricolage Grotesque',serif;font-size:28px;font-weight:700;color:#293855;line-height:1;margin-bottom:8px;">{{ totalCustomers }}</div>
      <a href="{{ path('app_customer_index') }}" style="font-size:12px;color:#4265d6;font-weight:500;text-decoration:none;">View customers &#x2192;</a>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-5">
    {% set actions = [
      {'icon': '&#x1F6D2;', 'label': 'Point of Sale', 'desc': 'Quick sale / walk-in', 'path': 'app_pos'},
      {'icon': '&#x2795;', 'label': 'Add Flower', 'desc': 'New inventory', 'path': 'app_flower_new'},
      {'icon': '&#x1F4CB;', 'label': 'New Reservation', 'desc': 'Walk-in or online', 'path': 'app_reservation_new'},
      {'icon': '&#x1F464;', 'label': 'Add Customer', 'desc': 'Register client', 'path': 'app_customer_new'},
      {'icon': '&#x1F69A;', 'label': 'Add Supplier', 'desc': 'Partner registration', 'path': 'app_supplier_new'}
    ] %}
    {% for a in actions %}
    <a href="{{ path(a.path) }}" class="flex items-center gap-2.5 bg-white rounded-xl transition-all duration-200" style="border:1px solid #e8edf2;padding:14px 16px;text-decoration:none;">
      <div class="flex items-center justify-center rounded-lg flex-shrink-0" style="width:32px;height:32px;background:#e8f7eb;font-size:15px;">{{ a.icon|raw }}</div>
      <div>
        <div style="font-size:13px;font-weight:500;color:#293855;">{{ a.label }}</div>
        <div style="font-size:11px;color:#6b7a8d;">{{ a.desc }}</div>
      </div>
    </a>
    {% endfor %}
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 mb-5">
    <div class="lg:col-span-2 bg-white rounded-xl overflow-hidden" style="border:1px solid #e8edf2;">
      <div class="flex items-center justify-between px-5 pt-5 mb-4">
        <div style="font-family:'Bricolage Grotesque',serif;font-size:16px;font-weight:600;color:#293855;">Flower Freshness Status</div>
        <a href="{{ path('app_flower_index') }}" style="font-size:12px;color:#4265d6;font-weight:500;text-decoration:none;">View all &#x2192;</a>
      </div>
      <div class="px-5 pb-5">
        {% set total = freshnessDistribution['Fresh'] + freshnessDistribution['Good'] + freshnessDistribution['Last Sale'] + freshnessDistribution['Expired'] %}
        {% if total > 0 %}
          <div class="flex items-end gap-2 mb-4" style="height:120px;padding-bottom:8px;border-bottom:1px solid #f0f3f7;">
            {% set categories = [
              {'label': 'Fresh', 'value': freshnessDistribution['Fresh'], 'color': '#22c55e'},
              {'label': 'Good', 'value': freshnessDistribution['Good'], 'color': '#eab308'},
              {'label': 'Last Sale', 'value': freshnessDistribution['Last Sale'], 'color': '#f97316'},
              {'label': 'Expired', 'value': freshnessDistribution['Expired'], 'color': '#ef4444'}
            ] %}
            {% for cat in categories %}
            <div class="flex-1 flex flex-col items-center gap-1 h-full justify-end">
              <div style="width:100%;border-radius:4px 4px 0 0;background:{{ cat.color }};height:{{ total > 0 ? ((cat.value / total) * 100)|round : 0 }}%;min-height:4px;"></div>
              <div style="font-size:10px;color:#6b7a8d;text-align:center;margin-top:4px;">{{ cat.label }}</div>
            </div>
            {% endfor %}
          </div>
          <div class="flex gap-4 mt-2">
            {% for cat in categories %}
            <div class="flex items-center gap-1.5" style="font-size:11px;color:#6b7a8d;">
              <div style="width:8px;height:8px;border-radius:2px;background:{{ cat.color }};"></div>
              {{ cat.label }} ({{ cat.value }})
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-8" style="color:#6b7a8d;">No flowers in inventory</div>
        {% endif %}
      </div>
    </div>

    <div class="bg-white rounded-xl overflow-hidden" style="border:1px solid #e8edf2;">
      <div class="flex items-center justify-between px-5 pt-5 mb-4">
        <div style="font-family:'Bricolage Grotesque',serif;font-size:16px;font-weight:600;color:#293855;">Expiring Soon</div>
        <span style="background:#fdecea;color:#c0392b;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:500;">{{ expiringSoonFlowers|length }} items</span>
      </div>
      <div class="px-5 pb-5">
        {% if expiringSoonFlowers is not empty %}
          {% for flower in expiringSoonFlowers[:5] %}
          <div class="flex items-center gap-3 py-2.5" style="border-bottom:1px solid #f3f5f8;">
            <div class="flex items-center justify-center rounded-lg flex-shrink-0" style="width:38px;height:38px;background:#fdecea;font-size:18px;">&#x1F339;</div>
            <div class="flex-1 min-w-0">
              <div style="font-size:13px;font-weight:500;color:#293855;">{{ flower.name }}</div>
              <div style="font-size:11px;color:#6b7a8d;">{{ flower.stockQuantity }} units</div>
            </div>
            <div class="text-right">
              <div style="font-size:12px;font-weight:600;color:#c0392b;">{{ flower.expiryDate|date('M d') }}</div>
              {% if flower.discountPrice %}
              <div style="font-size:11px;color:#2d8a4e;font-weight:600;">₱{{ flower.discountPrice|number_format(2) }}</div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center py-8">
            <div style="font-size:24px;margin-bottom:8px;">&#x2705;</div>
            <div style="font-size:13px;color:#6b7a8d;">No flowers expiring soon</div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl overflow-hidden mb-5" style="border:1px solid #e8edf2;">
    <div class="px-5 py-4" style="background:#293855;">
      <div style="font-family:'Bricolage Grotesque',serif;font-size:16px;font-weight:600;color:#c2e7c9;">Freshness Overview by Category</div>
      <div style="font-size:12px;color:rgba(194,231,201,0.6);margin-top:2px;">Real-time freshness distribution across flower categories</div>
    </div>
    <div class="overflow-x-auto">
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="border-bottom:1px solid #f0f3f7;">
            <th style="padding:10px 16px;text-align:left;font-size:11px;font-weight:500;color:#6b7a8d;text-transform:uppercase;">Category</th>
            <th style="padding:10px 16px;text-align:center;font-size:11px;font-weight:500;color:#16a34a;text-transform:uppercase;">Fresh</th>
            <th style="padding:10px 16px;text-align:center;font-size:11px;font-weight:500;color:#ca8a04;text-transform:uppercase;">Good</th>
            <th style="padding:10px 16px;text-align:center;font-size:11px;font-weight:500;color:#ea580c;text-transform:uppercase;">Last Sale</th>
            <th style="padding:10px 16px;text-align:center;font-size:11px;font-weight:500;color:#dc2626;text-transform:uppercase;">Expired</th>
            <th style="padding:10px 16px;text-align:center;font-size:11px;font-weight:500;color:#293855;text-transform:uppercase;">Total</th>
          </tr>
        </thead>
        <tbody>
          {% if freshnessByCategory is not empty %}
            {% for category, data in freshnessByCategory %}
            <tr style="border-bottom:1px solid #f7f9fb;">
              <td style="padding:12px 16px;"><span style="margin-right:8px;">&#x1F33F;</span><span style="font-weight:500;color:#293855;">{{ category }}</span></td>
              <td style="padding:12px 16px;text-align:center;"><span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:#dcfce7;color:#16a34a;font-size:13px;font-weight:600;border-radius:50%;">{{ data.Fresh }}</span></td>
              <td style="padding:12px 16px;text-align:center;"><span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:#fef9c3;color:#ca8a04;font-size:13px;font-weight:600;border-radius:50%;">{{ data.Good }}</span></td>
              <td style="padding:12px 16px;text-align:center;"><span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:#ffedd5;color:#ea580c;font-size:13px;font-weight:600;border-radius:50%;">{{ data['Last Sale'] }}</span>{% if data['Last Sale'] > 0 %}<div style="font-size:10px;color:#ea580c;font-weight:500;margin-top:2px;">20% OFF</div>{% endif %}</td>
              <td style="padding:12px 16px;text-align:center;"><span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:#fee2e2;color:#dc2626;font-size:13px;font-weight:600;border-radius:50%;">{{ data.Expired }}</span></td>
              <td style="padding:12px 16px;text-align:center;font-weight:700;color:#293855;">{{ data.total }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="6" style="padding:32px;text-align:center;color:#6b7a8d;">No flowers in inventory</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="bg-white rounded-xl overflow-hidden mb-5" style="border:1px solid #e8edf2;">
    <div class="flex items-center justify-between px-5 py-4" style="border-bottom:1px solid #e8edf2;">
      <div>
        <div style="font-family:'Bricolage Grotesque',serif;font-size:16px;font-weight:600;color:#293855;">Detailed Freshness by Flower</div>
        <div style="font-size:12px;color:#6b7a8d;margin-top:2px;">Individual flower inventory status</div>
      </div>
      <div class="flex gap-2" style="font-size:11px;">
        <span style="padding:2px 8px;background:#dcfce7;color:#166534;border-radius:4px;">Fresh</span>
        <span style="padding:2px 8px;background:#fef9c3;color:#854d0e;border-radius:4px;">Good</span>
        <span style="padding:2px 8px;background:#ffedd5;color:#9a3412;border-radius:4px;">Last Sale</span>
        <span style="padding:2px 8px;background:#fee2e2;color:#991b1b;border-radius:4px;">Expired</span>
      </div>
    </div>
    <div style="max-height:384px;overflow-y:auto;">
      {% if freshnessByFlowerName is not empty %}
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 p-5">
        {% for flowerName, data in freshnessByFlowerName %}
        <div class="rounded-lg p-4" style="background:#f9fafb;border:1px solid #e8edf2;">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div style="font-weight:600;color:#293855;">{{ flowerName }}</div>
              <div style="font-size:11px;color:#6b7a8d;">{{ data.category }}</div>
            </div>
            <span style="font-size:13px;font-weight:700;color:#293855;">{{ data.stockQuantity }} in stock</span>
          </div>
          {% set total = data.total %}
          {% if total > 0 %}
          {% if data.stockQuantity < 5 and data.stockQuantity > 0 %}
          <div style="font-size:11px;color:#c0392b;font-weight:500;margin-bottom:6px;">&#x26A0;&#xFE0F; Low stock</div>
          {% endif %}
          <div class="flex h-2 rounded-full overflow-hidden" style="background:#eef0f4;">
            {% if data.Fresh > 0 %}<div style="background:#22c55e;width:{{ (data.Fresh / total * 100)|round }}%;min-height:2px;"></div>{% endif %}
            {% if data.Good > 0 %}<div style="background:#eab308;width:{{ (data.Good / total * 100)|round }}%;min-height:2px;"></div>{% endif %}
            {% if data['Last Sale'] > 0 %}<div style="background:#f97316;width:{{ (data['Last Sale'] / total * 100)|round }}%;min-height:2px;"></div>{% endif %}
            {% if data.Expired > 0 %}<div style="background:#ef4444;width:{{ (data.Expired / total * 100)|round }}%;min-height:2px;"></div>{% endif %}
          </div>
          <div class="flex justify-between mt-2" style="font-size:11px;">
            <span style="color:#16a34a;">{{ data.Fresh }} Fresh</span>
            <span style="color:#ca8a04;">{{ data.Good }} Good</span>
            <span style="color:#ea580c;">{{ data['Last Sale'] }} Sale</span>
            <span style="color:#dc2626;">{{ data.Expired }} Exp</span>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-8" style="color:#6b7a8d;">No individual flowers tracked</div>
      {% endif %}
    </div>
  </div>

  <div class="bg-white rounded-xl overflow-hidden mb-5" style="border:1px solid #e8edf2;">
    <div class="flex items-center gap-3 px-5 py-4" style="background:#fdecea;border-bottom:1px solid #f5c6c2;">
      <span style="font-size:18px;">&#x26A0;&#xFE0F;</span>
      <div>
        <div style="font-family:'Bricolage Grotesque',serif;font-size:16px;font-weight:600;color:#c0392b;">Low Stock Alert</div>
        <div style="font-size:12px;color:#6b7a8d;">Flowers with fewer than 5 units in stock</div>
      </div>
    </div>
    <div class="overflow-x-auto">
      {% if lowStockFlowers is not empty %}
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="border-bottom:1px solid #f0f3f7;">
            <th style="padding:10px 16px;text-align:left;font-size:11px;font-weight:500;color:#6b7a8d;text-transform:uppercase;">Flower</th>
            <th style="padding:10px 16px;text-align:left;font-size:11px;font-weight:500;color:#6b7a8d;text-transform:uppercase;">Category</th>
            <th style="padding:10px 16px;text-align:left;font-size:11px;font-weight:500;color:#6b7a8d;text-transform:uppercase;">Stock</th>
            <th style="padding:10px 16px;text-align:left;font-size:11px;font-weight:500;color:#6b7a8d;text-transform:uppercase;">Status</th>
            <th style="padding:10px 16px;text-align:right;font-size:11px;font-weight:500;color:#6b7a8d;text-transform:uppercase;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for flower in lowStockFlowers %}
          <tr style="border-bottom:1px solid #f7f9fb;">
            <td style="padding:12px 16px;font-weight:500;color:#293855;">{{ flower.name }}</td>
            <td style="padding:12px 16px;color:#6b7a8d;">{{ flower.category }}</td>
            <td style="padding:12px 16px;color:#c0392b;font-weight:600;">{{ flower.stockQuantity }} units</td>
            <td style="padding:12px 16px;">
              <span style="display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:500;{{ flower.status == 'Available' ? 'background:#e8f7eb;color:#2d8a4e;' : 'background:#fdecea;color:#c0392b;' }}">{{ flower.status }}</span>
            </td>
            <td style="padding:12px 16px;text-align:right;">
              <a href="{{ path('app_flower_edit', {'id': flower.id}) }}" style="color:#4265d6;font-weight:500;font-size:13px;text-decoration:none;"><i class="fas fa-edit" style="margin-right:4px;"></i>Update</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="text-center py-10">
        <div style="font-size:32px;margin-bottom:8px;">&#x2705;</div>
        <div style="font-size:14px;font-weight:500;color:#293855;">All stocks are healthy</div>
        <div style="font-size:12px;color:#6b7a8d;">No low-stock alerts at the moment.</div>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
    <div class="lg:col-span-2 bg-white rounded-xl overflow-hidden" style="border:1px solid #e8edf2;">
      <div class="flex items-center justify-between px-5 py-4" style="border-bottom:1px solid #e8edf2;">
        <div style="font-family:'Bricolage Grotesque',serif;font-size:16px;font-weight:600;color:#293855;">Recent Activity</div>
        <a href="{{ path('app_activity_log_index') }}" style="font-size:12px;color:#4265d6;font-weight:500;text-decoration:none;">View all &#x2192;</a>
      </div>
      <div class="px-5 py-4 space-y-3">
        <div class="p-4 rounded-lg" style="background:#eaeefc;">
          <div style="font-size:13px;font-weight:500;color:#293855;">New reservation created</div>
          <div style="font-size:12px;color:#6b7a8d;margin-top:4px;">A customer placed a new flower reservation.</div>
        </div>
        <div class="p-4 rounded-lg" style="background:#e8f7eb;">
          <div style="font-size:13px;font-weight:500;color:#293855;">Stock updated</div>
          <div style="font-size:12px;color:#6b7a8d;margin-top:4px;">Supplier delivered new stocks to inventory.</div>
        </div>
      </div>
    </div>
    <div class="bg-white rounded-xl overflow-hidden" style="border:1px solid #e8edf2;">
      <div class="px-5 py-4" style="border-bottom:1px solid #e8edf2;">
        <div style="font-family:'Bricolage Grotesque',serif;font-size:16px;font-weight:600;color:#293855;">Monthly Summary</div>
      </div>
      <div class="px-5 py-4 space-y-4">
        <div class="flex justify-between"><span style="font-size:13px;color:#6b7a8d;">Total Revenue</span><span style="font-size:13px;font-weight:600;color:#293855;">₱0.00</span></div>
        <div class="flex justify-between"><span style="font-size:13px;color:#6b7a8d;">Orders This Month</span><span style="font-size:13px;font-weight:600;color:#4265d6;">{{ totalReservations }}</span></div>
        <div class="flex justify-between"><span style="font-size:13px;color:#6b7a8d;">New Customers</span><span style="font-size:13px;font-weight:600;color:#293855;">{{ totalCustomers }}</span></div>
        <div style="border-top:1px solid #e8edf2;padding-top:16px;margin-top:8px;">
          <a href="{{ path('app_reports_index') }}" style="font-size:12px;color:#4265d6;font-weight:500;text-decoration:none;">View full report &#x2192;</a>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}