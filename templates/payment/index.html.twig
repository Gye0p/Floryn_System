{% extends 'base.html.twig' %}

{% block title %}Payments - Floryn Garden{% endblock %}
{% block page_title %}Payment Management{% endblock %}

{% block body %}
<div class="page-wrapper px-4 sm:px-6 lg:px-8">
  <div class="page-header">
    <div class="page-header-info">
      <h1><i class="fas fa-credit-card" style="color:#22c55e;font-size:22px;"></i> Payment Transactions</h1>
      <p class="subtitle">Track payment history, process transactions, and manage financial records.</p>
    </div>
    <div class="page-header-actions">
      <a href="{{ path('app_payment_new') }}" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Record Payment</a>
    </div>
  </div>

  <div class="stat-grid">
    <div class="stat-card">
      <div class="stat-icon green"><i class="fas fa-credit-card"></i></div>
      <div class="stat-content">
        <div class="stat-label">Total Payments</div>
        <div class="stat-value">{{ payments|length }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon blue"><i class="fas fa-dollar-sign"></i></div>
      <div class="stat-content">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value">₱{% set totalRevenue = 0 %}{% for payment in payments %}{% if payment.status == 'Completed' or payment.status == 'Paid' %}{% set totalRevenue = totalRevenue + payment.amountPaid %}{% endif %}{% endfor %}{{ totalRevenue|number_format(2) }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon amber"><i class="fas fa-clock"></i></div>
      <div class="stat-content">
        <div class="stat-label">Pending</div>
        <div class="stat-value">{% set pending = 0 %}{% for payment in payments %}{% if payment.status == 'Pending' %}{% set pending = pending + 1 %}{% endif %}{% endfor %}{{ pending }}</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon purple"><i class="fas fa-calendar-day"></i></div>
      <div class="stat-content">
        <div class="stat-label">Today's Revenue</div>
        <div class="stat-value">₱{% set todayRevenue = 0 %}{% for payment in payments %}{% if payment.paymentDate and payment.paymentDate|date('Y-m-d') == date()|date('Y-m-d') and payment.status == 'Paid' %}{% set todayRevenue = todayRevenue + payment.amountPaid %}{% endif %}{% endfor %}{{ todayRevenue|number_format(2) }}</div>
      </div>
    </div>
  </div>

  {% if payments is not empty %}
  <div class="table-card"
       data-controller="floryn-table"
       data-floryn-table-page-size-value="10"
       data-floryn-table-sort-col-value="1"
       data-floryn-table-sort-dir-value="desc"
       data-floryn-table-no-sort-cols-value="[6]"
       data-floryn-table-entity-name-value="payments">

    <div class="table-card-header"><h3>All Payments</h3></div>

    <div class="fg-toolbar">
      <div class="fg-toolbar-left">
        <select class="fg-page-size" data-floryn-table-target="pageSize" data-action="floryn-table#onPageSizeChange">
          <option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="-1">All</option>
        </select>
        <div class="fg-export-buttons">
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportCopy"><i class="fas fa-copy"></i> Copy</button>
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportCsv"><i class="fas fa-file-csv"></i> CSV</button>
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportExcel"><i class="fas fa-file-excel"></i> Excel</button>
          <button type="button" class="fg-export-btn" data-action="floryn-table#exportPrint"><i class="fas fa-print"></i> Print</button>
        </div>
      </div>
      <div class="fg-toolbar-right">
        <select class="filter-select" data-floryn-table-target="columnFilter" data-col="5" data-action="floryn-table#onColumnFilter">
          <option value="">All Status</option><option value="Paid">Paid</option><option value="Cancelled">Cancelled</option>
        </select>
        <select class="filter-select" data-floryn-table-target="columnFilter" data-col="3" data-action="floryn-table#onColumnFilter">
          <option value="">All Methods</option><option value="Cash">Cash</option><option value="Credit Card">Credit Card</option><option value="Bank Transfer">Bank Transfer</option><option value="GCash">GCash</option>
        </select>
        <button type="button" class="btn-outline" data-action="floryn-table#resetFilters" style="padding:8px 14px;font-size:12px;"><i class="fas fa-redo"></i> Reset</button>
        <div class="fg-search-wrap">
          <i class="fas fa-search fg-search-icon"></i>
          <input type="text" class="fg-search" placeholder="Search payments..." data-floryn-table-target="search" data-action="input->floryn-table#onSearch">
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="fg-table min-w-full" style="width:100%" data-floryn-table-target="table">
        <thead>
          <tr><th>Payment</th><th>Reservation</th><th>Amount</th><th>Method</th><th>Reference</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody>
          {% for payment in payments %}
          <tr>
            <td class="px-4 py-3">
              <div class="flex items-center gap-3">
                <div class="avatar sm" style="background:linear-gradient(135deg,#22c55e,#16a34a);"><i class="fas fa-dollar-sign" style="font-size:11px;"></i></div>
                <div>
                  <div style="font-weight:600;color:var(--navy);font-size:13px;">#{{ payment.id }}</div>
                  <div style="font-size:11px;color:var(--muted);">{{ payment.paymentDate ? payment.paymentDate|date('M j, Y g:i A') : 'No date' }}</div>
                </div>
              </div>
            </td>
            <td class="px-4 py-3">
              {% if payment.reservation %}
                <div style="font-weight:600;font-size:13px;color:var(--navy);">Reservation #{{ payment.reservation.id }}</div>
                <div style="font-size:11px;color:var(--muted);">{{ payment.reservation.customer.fullName }}</div>
              {% else %}<span style="color:var(--muted);font-style:italic;font-size:13px;">No reservation</span>{% endif %}
            </td>
            <td class="px-4 py-3"><div style="font-weight:700;font-size:16px;color:var(--navy);">₱{{ payment.amountPaid|number_format(2) }}</div></td>
            <td class="px-4 py-3">
              <span class="pill {% if payment.paymentMethod == 'Credit Card' %}blue{% elseif payment.paymentMethod == 'Cash' %}green{% elseif payment.paymentMethod == 'Bank Transfer' %}navy{% else %}gray{% endif %}">
                {% if payment.paymentMethod == 'Credit Card' %}<i class="fas fa-credit-card" style="margin-right:3px;"></i>
                {% elseif payment.paymentMethod == 'Cash' %}<i class="fas fa-money-bill-wave" style="margin-right:3px;"></i>
                {% elseif payment.paymentMethod == 'Bank Transfer' %}<i class="fas fa-university" style="margin-right:3px;"></i>
                {% else %}<i class="fas fa-wallet" style="margin-right:3px;"></i>{% endif %}
                {{ payment.paymentMethod }}
              </span>
            </td>
            <td class="px-4 py-3"><div style="font-family:monospace;font-size:13px;color:var(--navy);">{{ payment.referenceNo }}</div></td>
            <td class="px-4 py-3">
              <span class="pill {% if payment.status == 'Paid' or payment.status == 'Completed' %}green{% elseif payment.status == 'Pending' %}yellow{% elseif payment.status == 'Processing' %}blue{% else %}red{% endif %}">
                {% if payment.status == 'Paid' or payment.status == 'Completed' %}<i class="fas fa-check-circle" style="margin-right:3px;"></i>
                {% elseif payment.status == 'Pending' %}<i class="fas fa-clock" style="margin-right:3px;"></i>
                {% else %}<i class="fas fa-times-circle" style="margin-right:3px;"></i>{% endif %}
                {{ payment.status }}
              </span>
            </td>
            <td class="px-4 py-3 text-right">
              <div class="row-actions">
                <a href="{{ path('app_payment_show', {'id': payment.id}) }}" class="row-action-btn" title="View"><i class="fas fa-eye"></i></a>
                <a href="{{ path('app_payment_edit', {'id': payment.id}) }}" class="row-action-btn" title="Edit"><i class="fas fa-edit"></i></a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="fg-bottom-bar">
      <div class="fg-info" data-floryn-table-target="info"></div>
      <div class="fg-pagination" data-floryn-table-target="pagination"></div>
    </div>

  {% else %}
    <div class="section-card">
      <div class="empty-state">
        <div class="empty-state-icon"><i class="fas fa-credit-card"></i></div>
        <h3>No payments found</h3>
        <p>Start processing payments by recording your first transaction.</p>
        <a href="{{ path('app_payment_new') }}" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Record First Payment</a>
      </div>
    </div>
  {% endif %}
  </div>
</div>
{% endblock %}